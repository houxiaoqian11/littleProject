<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:rabbit="http://www.springframework.org/schema/rabbit"
	xmlns:util="http://www.springframework.org/schema/util"
	xsi:schemaLocation="http://www.springframework.org/schema/rabbit http://www.springframework.org/schema/rabbit/spring-rabbit-1.3.xsd
		http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd 
		http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-4.0.xsd">

    <!-- 消息队列连接工厂 -->
    <rabbit:connection-factory id="connectionFactory"
	  	cache-mode="CONNECTION" 
	  	connection-cache-size="100"
	  	addresses="${sumapay.amqp.urls}"
	  	virtual-host="${sumapay.amqp.virtualhost}"
	  	username="${sumapay.amqp.user}"
	  	password="${sumapay.amqp.password}"
    	publisher-returns="true"
    />
    
    <!-- ################消费者（监听工行消息队列）################## -->
    <rabbit:listener-container id="connectorListener"
		auto-startup="false"
	 	connection-factory="connectionFactory" 
	 	concurrency="${sumapay.amqp.minconsumercount}"
	 	max-concurrency="${sumapay.amqp.maxconsumercount}"
	 	min-start-interval="100"
	 	min-stop-interval="10000"
    	acknowledge="manual"
	 	prefetch="1">
		<rabbit:listener ref="rpcListener" queue-names="${bank.ucfpayfastpay.queue}" priority="100"/>
	</rabbit:listener-container>
	
    <rabbit:template id="rabbitTemplate"
			    	connection-factory="connectionFactory" 
			    	encoding="UTF-8"/>
	
	<bean id="rpcListener" class="com.sumapay.mq.client.remoting.SumapayAmqpInvokerServiceExporter">
		<property name="serviceInterface" value="${connector.service.interface}" />
		<property name="service" ref="bankConnectorProxy" />
		<property name="amqpTemplate" ref="rabbitTemplate" />
		<property name="method" value="process" />	<!-- 当使用通用的客户端发起请求时需要使用 -->
		<property name="methodParameterType" value="java.util.Map"></property>
		<property name="simpleListenerContainer" ref="connectorListener"></property>
		<property name="maxConsumerCount" value="${sumapay.amqp.maxconsumercount}"></property>
		<property name="repeatMessageSender" ref="repeatMessageSender"></property>
	</bean>
    <!-- ################################################### -->
	
	
    <!-- ##################交易系统客户端配置################### -->
    <rabbit:template id="rabbitTemplate-trade"
			    	connection-factory="connectionFactory" 
			    	exchange="${trade.exchange}"
			    	routing-key="${trade.exchange}"
			    	mandatory="true"
			    	encoding="UTF-8"
			    	reply-timeout="${sumapay.amqp.rpc.timeout}">
    </rabbit:template>
    <bean id="springamqpclient" class="com.sumapay.mq.client.remoting.AdjustableAmqpProxyFactoryBean">
		<property name="amqpTemplate" ref="rabbitTemplate-trade" />
		<property name="serviceInterface" value="${front.service.businessInterface}" />
		<property name="routingKeyPattern" value="{TRADE_CODE}"></property>
	</bean>
    <!-- ################################################### -->
    
    <bean id="rabbitmqListenerJmx" class="org.springframework.jmx.export.MBeanExporter"
        lazy-init="false"> 
        <property name="beans"> 
            <map> 
                <entry key="bean:name=ucfpayfastpayrabbitmqListenerJmx" value-ref="rpcListener" /> 
            </map> 
        </property> 
    </bean>
    
    <rabbit:template id="repeatRabbitTemplate"
	connection-factory="connectionFactory" exchange="${sumapay.repeat.exchange}" routing-key="repeat.message"
		mandatory="true" encoding="UTF-8" reply-timeout="${sumapay.amqp.rpc.timeout}" />
	
	<bean id="repeatMessageSender" class="com.sumapay.mq.client.sender.impl.SumapayMessageSender">
		<property name="rabbitTemplate" ref="repeatRabbitTemplate"></property>
	</bean>
	
    <!-- ##################通用客户端配置################### -->
    <rabbit:template id="rabbitTemplate-common"
			    	connection-factory="connectionFactory" 
			    	mandatory="true"
			    	encoding="UTF-8"
			    	reply-timeout="${sumapay.amqp.rpc.timeout}">
    </rabbit:template>

	<!-- ##通用消息发送工具## -->
	<bean id="messagePublisher" class="com.sumapay.mq.client.sender.impl.SumapayMessageSender">
		<property name="rabbitTemplate" ref="rabbitTemplate-common"></property>
	</bean>
</beans>
